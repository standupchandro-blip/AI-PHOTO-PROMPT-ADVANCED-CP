<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompter</title>
    <!-- Home Screen/App Icon Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Prompter">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/1e40af/ffffff?text=AI">
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/1e40af/ffffff?text=AI">


    <!-- Minimal, self-contained CSS for high compatibility -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 440px;
            background: #ffffff;
            margin: 20px;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }
        h2 {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-top: 0;
            margin-bottom: 16px;
        }
        p {
            font-size: 14px;
            color: #6b7280;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 48%;
        }
        .btn-blue {
            background-color: #3b82f6;
            color: white;
        }
        .btn-blue:hover {
            background-color: #2563eb;
        }
        .btn-gray {
            background-color: #d1d5db;
            color: #374151;
        }
        .btn-gray:hover {
            background-color: #9ca3af;
        }
        .btn-green {
            background-color: #10b981;
            color: white;
            width: 100%;
            margin-top: 15px;
        }
        .btn-green:hover {
            background-color: #059669;
        }
        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            width: 100%;
            margin-top: 10px;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            margin-top: 20px;
        }
        .final-prompt-box {
            background-color: #f9fafb;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            color: #1f2937;
            min-height: 100px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .hidden {
            display: none;
        }
        .step-container {
            min-height: 250px;
        }
        .icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        
        /* Custom Radio/Checkbox Styling */
        .radio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .radio-grid input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .radio-grid label {
            display: block;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 400;
            font-size: 14px;
        }
        .radio-grid input[type="radio"]:checked + label {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }
        .radio-grid label:hover:not(.radio-grid input[type="radio"]:checked + label) {
            border-color: #60a5fa;
        }


        /* Toast Message */
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>


    <div class="container">
        <h1>Prompter 🧠</h1>
        <p>Build the perfect prompt in 5 simple steps.</p>


        <!-- Progress Bar -->
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
        </div>
        <p id="progressText" style="text-align: right; margin-bottom: 20px;">Step 1 of 5</p>


        <!-- Step Content -->
        <div id="stepContainer" class="step-container">
            <!-- Content will be injected here -->
        </div>


        <!-- Navigation -->
        <div class="navigation">
            <button id="backBtn" class="btn btn-gray" onclick="navigateStep(-1)" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="m15 18-6-6 6-6"/></svg>
                Back
            </button>
            <button id="nextBtn" class="btn btn-blue" onclick="navigateStep(1)">
                Next
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="m9 18 6-6-6-6"/></svg>
            </button>
            <button id="finishBtn" class="btn btn-green hidden" onclick="restartPrompt()">
                Start Over
            </button>
        </div>
    </div>
    
    <!-- Message Box -->
    <div id="messageBox" class="message-box hidden"></div>


    <script>
        // --- State Management and Configuration ---
        const TOTAL_STEPS = 6; // Steps 1-5 + Review Step 6
        let currentStep = 1;
        const promptData = {
            subject: "", action: "",
            medium: "", customStyle: "",
            moodLighting: "", customLighting: "",
            composition: "", customComposition: "",
            finalMods: "8k, highly detailed, smooth, trending on ArtStation"
        };
        let aiEnhancementText = "";


        // API Configuration (Empty string for Canvas execution)
        const MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 3;


        const STEPS_CONFIG = [
            { id: 1, title: "The Core Idea 🌟" },
            { id: 2, title: "Medium & Style 🎨" },
            { id: 3, title: "Mood & Lighting 💡" },
            { id: 4, title: "Composition 📐" },
            { id: 5, title: "Final Quality Boosters ✨" },
            { id: 6, title: "Review & Output 🚀" }
        ];


        // --- DOM Elements ---
        const stepContainer = document.getElementById('stepContainer');
        const backBtn = document.getElementById('backBtn');
        const nextBtn = document.getElementById('nextBtn');
        const finishBtn = document.getElementById('finishBtn');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const messageBox = document.getElementById('messageBox');
        
        let isGenerating = false; // Flag to prevent re-clicks during fetch


        // --- UI Helper Functions ---


        function showMessage(text, type = 'success', duration = 3000) {
            messageBox.innerHTML = text;
            
            // Set color based on type (green for success, red for error)
            messageBox.style.backgroundColor = type === 'error' ? '#ef4444' : (type === 'info' ? '#3b82f6' : '#10b981');
            
            messageBox.classList.remove('hidden');


            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }


        // --- Core Logic ---


        function updatePromptData(event) {
            const element = event.target;
            const key = element.id || element.name;
            
            if (element.type === 'radio') {
                promptData[element.name] = element.value.trim();
            } else {
                promptData[key] = element.value.trim();
            }
        }


        function generateBasePrompt() {
            const parts = [
                promptData.subject, promptData.action,
                promptData.medium, promptData.customStyle,
                promptData.moodLighting, promptData.customLighting,
                promptData.composition, promptData.customComposition,
                promptData.finalMods
            ];


            return parts
                .map(part => part.trim())
                .filter(part => part)
                .join(', ');
        }
        
        function getFinalPrompt() {
            const base = generateBasePrompt();
            if (aiEnhancementText.trim()) {
                return [base, aiEnhancementText.trim()].filter(t => t).join(', ');
            }
            return base;
        }
        
        function copyPrompt() {
            const promptToCopy = getFinalPrompt();
            if (!promptToCopy) {
                showMessage("Nothing to copy!", 'error');
                return;
            }


            // Standard DOM copy trick
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = promptToCopy;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            
            try {
                document.execCommand('copy');
                showMessage('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/></svg>Prompt Copied Successfully!');
            } catch (err) {
                console.error('Copy command failed:', err);
                showMessage("Copy failed. Please manually select the text.", 'error');
            }
            
            document.body.removeChild(tempTextarea);
        }
        
        function restartPrompt() {
            // Reset all values to initial state
            Object.assign(promptData, {
                subject: "", action: "",
                medium: "", customStyle: "",
                moodLighting: "", customLighting: "",
                composition: "", customComposition: "",
                finalMods: "8k, highly detailed, smooth, trending on ArtStation"
            });
            aiEnhancementText = ""; // Clear AI text
            currentStep = 1;
            updateUI();
        }


        // --- AI Fetch Logic ---


        async function generateEnhancedPrompt() {
            if (isGenerating) return;


            const basePrompt = generateBasePrompt();
            if (!basePrompt || !promptData.subject.trim()) {
                showMessage("Please fill in the Subject in Step 1 before enhancing.", 'error');
                return;
            }


            const enhanceBtn = document.getElementById('enhanceBtn');
            if (!enhanceBtn) return;
            
            isGenerating = true;
            aiEnhancementText = ""; // Clear previous text
            enhanceBtn.classList.add('btn-disabled');
            enhanceBtn.innerHTML = '<div class="loader"></div> Enhancing...';
            
            // Re-render to show updated output box
            updateUI(); 


            // --- API Call ---


            const userQuery = `The foundational prompt elements are: "${basePrompt}". Based on this, provide deeper descriptive details for the AI model about the environment, character, and mood.`;
            const systemPrompt = "You are a master visual storyteller and prompt engineer for AI image generators. Your task is to take a foundational prompt and expand upon it with rich, descriptive details about the environment, character state (clothing, emotion, minor actions), key textures, and subtle mood elements. Do not repeat the core subject or action keywords. Provide the enhancement as a single, detailed paragraph of text, ready to be appended to an existing prompt.";


            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };


            let successful = false;


            // Introduce a short delay to let the UI render the loading state before the heavy fetch starts
            await new Promise(resolve => setTimeout(resolve, 500)); 


            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });


                    if (!response.ok) throw new Error(`API status: ${response.status}`);


                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    
                    aiEnhancementText = text.trim();
                    showMessage('AI Enhancement added successfully!', 'info');
                    successful = true;
                    break;
                } catch (error) {
                    console.error(`AI Attempt ${i + 1} failed:`, error);
                    // Exponential backoff
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
            }


            if (!successful) {
                showMessage('AI enhancement failed after retries.', 'error');
            }


            // Clean up UI regardless of success/failure
            isGenerating = false;
            enhanceBtn.classList.remove('btn-disabled');
            enhanceBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M12 2a10 10 0 0 0-9 15.5L3 21l3.5-1A10 10 0 1 0 12 2z"/></svg> Enhance with AI';
            updateUI();
        }


        // --- UI Rendering Functions ---


        function renderStepContent() {
            let html = '';
            const step = STEPS_CONFIG.find(c => c.id === currentStep);


            switch (currentStep) {
                case 1:
                    html = `
                        <h3 class="text-sm font-weight: bold; color: #6b7280; margin-bottom: 8px;">${step.title}</h3>
                        <div class="form-group">
                            <label for="subject">Who or what is the main subject? (Required)</label>
                            <input type="text" id="subject" value="${promptData.subject}" oninput="updatePromptData(event)" placeholder="e.g., A silver dragon, A single rose">
                        </div>
                        <div class="form-group">
                            <label for="action">What is the subject doing/where is it?</label>
                            <input type="text" id="action" value="${promptData.action}" oninput="updatePromptData(event)" placeholder="e.g., soaring over a stormy sea, eating chips in his bedroom">
                        </div>
                    `;
                    break;
                case 2:
                    html = `
                        <h3 class="text-sm font-weight: bold; color: #6b7280; margin-bottom: 8px;">${step.title}</h3>
                        <p>How do you want the image to look? (Choose one or add your own)</p>
                        <div class="radio-grid">
                            <input type="radio" id="style-photo" name="medium" value="professional photography, detailed, photorealistic" onchange="updatePromptData(event)" ${promptData.medium === 'professional photography, detailed, photorealistic' ? 'checked' : ''}>
                            <label for="style-photo">Photography</label>
                            
                            <input type="radio" id="style-art" name="medium" value="digital painting, highly detailed, fantasy art" onchange="updatePromptData(event)" ${promptData.medium === 'digital painting, highly detailed, fantasy art' ? 'checked' : ''}>
                            <label for="style-art">Digital Painting</label>
                            
                            <input type="radio" id="style-3d" name="medium" value="3D render, Octane render, unreal engine" onchange="updatePromptData(event)" ${promptData.medium === '3D render, Octane render, unreal engine' ? 'checked' : ''}>
                            <label for="style-3d">3D Render (CGI)</label>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="customStyle">Custom Style/Medium:</label>
                            <textarea id="customStyle" rows="2" oninput="updatePromptData(event)" placeholder="e.g., inspired by Van Gogh, 8-bit pixel art">${promptData.customStyle}</textarea>
                        </div>