import React, { useState, useEffect, useCallback } from 'react';
import { Clipboard, Brain, RotateCcw, ArrowLeft, ArrowRight, X } from 'lucide-react';


// Configuration for the Gemini API
const MODEL = 'gemini-2.5-flash-preview-09-2025';
const API_KEY = ""; // Placeholder for Canvas API Key injection
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
const MAX_RETRIES = 3;


/**
 * Initial state structure for the prompt builder data.
 */
const initialPromptData = {
    subject: "",
    action: "",
    medium: "",
    customStyle: "",
    moodLighting: "",
    customLighting: "",
    composition: "",
    customComposition: "",
    finalMods: "8k, highly detailed, smooth, trending on ArtStation"
};


/**
 * Defines the steps and their labels for navigation.
 */
const STEPS_CONFIG = [
    { id: 1, title: "The Core Idea 🌟" },
    { id: 2, title: "Medium & Style 🎨" },
    { id: 3, title: "Mood & Lighting 💡" },
    { id: 4, title: "Composition 📐" },
    { id: 5, title: "Final Quality Boosters ✨" },
    { id: 6, title: "Review & Enhance! 🚀" }
];
const TOTAL_STEPS = STEPS_CONFIG.length;




// --- Helper Components ---


/**
 * A reusable button component with built-in Tailwind styling.
 * @param {string} type - 'primary', 'success', 'secondary', 'nav-blue', 'nav-gray'
 */
const Button = ({ children, onClick, disabled, className = '', type = 'primary', icon: Icon, ...props }) => {
    let baseStyles = 'flex items-center justify-center font-bold rounded-xl transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 w-full';
    let typeStyles = '';
    
    switch (type) {
        case 'success':
            typeStyles = 'bg-green-600 text-white py-3 px-4 hover:bg-green-700 focus:ring-green-300/50';
            break;
        case 'secondary':
            typeStyles = 'bg-gray-300 text-gray-800 py-2 px-4 hover:bg-gray-400 focus:ring-gray-300/50';
            break;
        case 'nav-blue':
            typeStyles = 'bg-blue-600 text-white py-2 px-6 hover:bg-blue-700 focus:ring-blue-300/50 font-semibold';
            baseStyles = 'flex items-center justify-center rounded-xl transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4';
            break;
        case 'nav-gray':
            typeStyles = 'bg-gray-300 text-gray-800 py-2 px-6 hover:bg-gray-400 focus:ring-gray-300/50 font-semibold';
            baseStyles = 'flex items-center justify-center rounded-xl transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4';
            break;
        case 'primary':
        default:
            typeStyles = 'bg-indigo-600 text-white py-3 px-4 hover:bg-indigo-700 focus:ring-indigo-300/50';
            break;
    }


    return (
        <button
            className={`${baseStyles} ${typeStyles} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
            onClick={onClick}
            disabled={disabled}
            {...props}
        >
            {Icon && <Icon className="w-5 h-5 mr-2" />}
            {children}
        </button>
    );
};


/**
 * Custom toast/message box for non-blocking notifications.
 */
const MessageBox = ({ message, type, isVisible, onClose }) => {
    let bgColor = '';
    let icon = null;


    if (!isVisible) return null;


    switch (type) {
        case 'success':
            bgColor = 'bg-green-600';
            icon = <Clipboard className="w-5 h-5 mr-2" />;
            break;
        case 'error':
            bgColor = 'bg-red-600';
            icon = <X className="w-5 h-5 mr-2" />;
            break;
        case 'info':
        default:
            bgColor = 'bg-indigo-600';
            icon = <Brain className="w-5 h-5 mr-2" />;
            break;
    }


    return (
        <div
            className={`fixed bottom-5 left-1/2 transform -translate-x-1/2 ${bgColor} text-white p-3 rounded-lg shadow-2xl transition-opacity duration-300`}
            style={{ opacity: isVisible ? 1 : 0, zIndex: 100 }}
        >
            <div className="flex items-center">
                {icon}
                <span>{message}</span>
                <button onClick={onClose} className="ml-4 p-1 rounded-full hover:bg-white/20">
                    <X className="w-4 h-4" />
                </button>
            </div>
        </div>
    );
};


// --- Main Application Component ---


const App = () => {
    const [currentStep, setCurrentStep] = useState(1);
    const [promptData, setPromptData] = useState(initialPromptData);
    const [aiEnhancementText, setAiEnhancementText] = useState("");
    const [isGenerating, setIsGenerating] = useState(false);
    const [message, setMessage] = useState({ text: '', type: 'info', visible: false });


    // --- State Management Handlers ---


    const handleDataChange = useCallback((e) => {
        const { id, name, value, type, checked } = e.target;
        const key = id || name;


        // Handle radio buttons vs. text inputs
        const newValue = type === 'radio' ? (checked ? value : promptData[key]) : value;


        setPromptData(prev => ({
            ...prev,
            [key]: newValue.trim()
        }));
    }, [promptData]);


    // --- UI/Navigation Functions ---


    const showMessage = useCallback((text, type = 'info', duration = 2500) => {
        setMessage({ text, type, visible: true });
        if (duration) {
            setTimeout(() => {
                setMessage(prev => ({ ...prev, visible: false }));
            }, duration);
        }
    }, []);


    /**
     * Gathers data and validates the required field (Subject in Step 1).
     */
    const validateAndCapture = useCallback(() => {
        if (currentStep === 1) {
            if (!promptData.subject) {
                showMessage("Please enter the main subject to proceed.", 'error');
                return false;
            }
        }
        return true;
    }, [currentStep, promptData.subject, showMessage]);


    /**
     * Navigates between steps, validating when moving forward.
     */
    const navigateStep = useCallback((direction) => {
        if (direction > 0 && currentStep < TOTAL_STEPS) {
            if (!validateAndCapture()) {
                return;
            }
        }
        
        setCurrentStep(prev => Math.min(TOTAL_STEPS, Math.max(1, prev + direction)));
    }, [currentStep, validateAndCapture]);


    /**
     * Generates the structured prompt string from all input fields.
     */
    const generateBasePrompt = useCallback(() => {
        const parts = [
            promptData.subject, promptData.action, 
            promptData.medium, promptData.customStyle, 
            promptData.moodLighting, promptData.customLighting, 
            promptData.composition, promptData.customComposition, 
            promptData.finalMods
        ];


        return parts
            .map(part => part.trim())
            .filter(part => part)
            .join(', ');
    }, [promptData]);


    /**
     * Combines the base prompt and AI enhancement text for the final output box.
     */
    const getFinalPrompt = useCallback(() => {
        const base = generateBasePrompt();
        return [base, aiEnhancementText]
            .map(part => part.trim())
            .filter(part => part)
            .join(', ');
    }, [generateBasePrompt, aiEnhancementText]);


    /**
     * Clears state and returns to Step 1.
     */
    const restart = () => {
        setPromptData(initialPromptData);
        setAiEnhancementText("");
        setCurrentStep(1);
        showMessage("Wizard restarted! Start crafting your next prompt.", 'info');
    };


    /**
     * Copies the final prompt to the clipboard using the standard DOM copy method.
     */
    const copyPrompt = () => {
        const promptToCopy = getFinalPrompt();
        if (!promptToCopy) {
            showMessage("Nothing to copy!", 'error');
            return;
        }


        // Create a temporary textarea to perform the copy
        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = promptToCopy;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        
        try {
            document.execCommand('copy');
            showMessage("Prompt Copied Successfully!", 'success');
        } catch (err) {
            console.error('Copy command failed:', err);
            showMessage("Copy failed. Please manually select the text.", 'error');
        }
        
        document.body.removeChild(tempTextarea);
    };


    // --- LLM Integration ---


    /**
     * Calls the Gemini API to generate deep descriptive details based on the base prompt.
     */
    const generateEnhancedPrompt = useCallback(async () => {
        const basePrompt = generateBasePrompt();
        if (!basePrompt) {
            showMessage("Please fill in the Subject in Step 1 before enhancing.", 'error');
            return;
        }


        setIsGenerating(true);
        setAiEnhancementText(""); // Clear previous text
        showMessage('Requesting AI enhancement...', 'info');


        const userQuery = `The foundational prompt elements are: "${basePrompt}". Based on this, provide deeper descriptive details for the AI model about the environment, character, and mood.`;
        const systemPrompt = "You are a master visual storyteller and prompt engineer for AI image generators. Your task is to take a foundational prompt and expand upon it with rich, descriptive details about the environment, character state (clothing, emotion, minor actions), key textures, and subtle mood elements. Do not repeat the core subject or action keywords. Provide the enhancement as a single, detailed paragraph of text, ready to be appended to an existing prompt.";


        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };


        let successful = false;


        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });


                if (!response.ok) throw new Error(`API status: ${response.status}`);


                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                
                setAiEnhancementText(text.trim());
                showMessage('AI Enhancement added successfully!', 'success');
                successful = true;
                break;
            } catch (error) {
                console.error(`Attempt ${i + 1} failed:`, error);
                if (i < MAX_RETRIES - 1) {
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }


        if (!successful) {
            showMessage('AI enhancement failed after retries.', 'error');
        }


        setIsGenerating(false);
    }, [generateBasePrompt, showMessage]);


    // --- Render Logic for Steps ---


    const renderStepContent = useCallback(() => {
        switch (currentStep) {
            case 1:
                return (
                    <div className="space-y-4">
                        <div>
                            <label htmlFor="subject" className="block text-sm font-medium text-gray-700 mb-1">Who or what is the main subject? (Required)</label>
                            <input
                                type="text"
                                id="subject"
                                name="subject"
                                value={promptData.subject}
                                onChange={handleDataChange}
                                placeholder="e.g., A silver dragon, Spiderman, A single rose"
                                className="w-full p-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-200/50 transition"
                            />
                        </div>
                        <div>
                            <label htmlFor="action" className="block text-sm font-medium text-gray-700 mb-1">What is the subject doing/where is it?</label>
                            <input
                                type="text"
                                id="action"
                                name="action"
                                value={promptData.action}
                                onChange={handleDataChange}
                                placeholder="e.g., soaring over a stormy sea, eating chips in his bedroom"
                                className="w-full p-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-200/50 transition"
                            />
                        </div>
                    </div>
                );
            case 2:
                return (
                    <div>
                        <p className="text-sm text-gray-500 mb-3">How do you want the image to look? (Choose one or add your own)</p>
                        <div className="grid grid-cols-2 gap-3 custom-radio mb-4">
                            {[
                                { id: 'style-photo', value: 'professional photography, detailed, photorealistic', label: 'Photography' },
                                { id: 'style-art', value: 'digital painting, highly detailed, fantasy art', label: 'Digital Painting' },
                                { id: 'style-3d', value: '3D render, Octane render, unreal engine', label: '3D Render (CGI)' },
                                { id: 'style-anime', value: 'anime aesthetic, volumetric lighting, cel-shaded', label: 'Anime/Cartoon' },
                            ].map(({ id, value, label }) => (
                                <div key={id}>
                                    <input type="radio" id={id} name="medium" value={value} onChange={handleDataChange} checked={promptData.medium === value} className="absolute opacity-0 w-0 h-0" />
                                    <label htmlFor={id} className={`cursor-pointer block p-3 border-2 rounded-xl text-center transition-all ${promptData.medium === value ? 'bg-blue-600 text-white border-blue-600 shadow-lg' : 'border-gray-300 hover:border-blue-300'}`}>
                                        {label}
                                    </label>
                                </div>
                            ))}
                        </div>
                        <div>
                            <label htmlFor="customStyle" className="block text-sm font-medium text-gray-700 mb-1">Add Custom Details for Style (Optional):</label>
                            <textarea
                                id="customStyle"
                                name="customStyle"
                                rows="2"
                                value={promptData.customStyle}
                                onChange={handleDataChange}
                                placeholder="e.g., inspired by Van Gogh, 8-bit pixel art, macro lens shot"
                                className="w-full p-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-200/50 transition resize-none"
                            ></textarea>
                        </div>
                    </div>
                );
            case 3:
                return (
                    <div>
                        <p className="text-sm text-gray-500 mb-3">Set the atmosphere of the scene. (Choose one or add your own)</p>
                        <div className="grid grid-cols-2 gap-3 custom-radio mb-4">
                            {[
                                { id: 'mood-cinematic', value: 'cinematic volumetric lighting, dramatic shadows, moody', label: 'Cinematic/Moody' },
                                { id: 'mood-soft', value: 'soft focus, tranquil, peaceful atmosphere', label: 'Soft/Peaceful' },
                                { id: 'mood-neon', value: 'neon glow, cyberpunk aesthetic, dark streets', label: 'Neon/Cyberpunk' },
                                { id: 'mood-golden', value: 'golden hour, warm, diffused sunlight', label: 'Golden Hour' },
                            ].map(({ id, value, label }) => (
                                <div key={id}>
                                    <input type="radio" id={id} name="moodLighting" value={value} onChange={handleDataChange} checked={promptData.moodLighting === value} className="absolute opacity-0 w-0 h-0" />
                                    <label htmlFor={id} className={`cursor-pointer block p-3 border-2 rounded-xl text-center transition-all ${promptData.moodLighting === value ? 'bg-blue-600 text-white border-blue-600 shadow-lg' : 'border-gray-300 hover:border-blue-300'}`}>
                                        {label}
                                    </label>
                                </div>
                            ))}
                        </div>
                        <div>
                            <label htmlFor="customLighting" className="block text-sm font-medium text-gray-700 mb-1">Add Custom Details for Lighting (Optional):</label>
                            <textarea
                                id="customLighting"
                                name="customLighting"
                                rows="2"
                                value={promptData.customLighting}
                                onChange={handleDataChange}
                                placeholder="e.g., strong rim light, single overhead lamp, foggy morning light"
                                className="w-full p-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-200/50 transition resize-none"
                            ></textarea>
                        </div>
                    </div>
                );
            case 4:
                return (
                    <div>
                        <p className="text-sm text-gray-500 mb-3">How should the elements be arranged? (Choose one or add your own)</p>
                        <div className="grid grid-cols-2 gap-3 custom-radio mb-4">
                            {[
                                { id: 'comp-thirds', value: 'rule of thirds, symmetrical composition', label: 'Symmetrical/Rule of Thirds' },
                                { id: 'comp-macro', value: 'macro photograph, extreme close-up', label: 'Macro/Close-Up' },
                                { id: 'comp-dutch', value: 'dutch angle, chaotic perspective', label: 'Dutch Angle' },
                                { id: 'comp-wide', value: 'ultra-wide shot, vast landscape, epic scale', label: 'Epic/Wide Shot' },
                            ].map(({ id, value, label }) => (
                                <div key={id}>
                                    <input type="radio" id={id} name="composition" value={value} onChange={handleDataChange} checked={promptData.composition === value} className="absolute opacity-0 w-0 h-0" />
                                    <label htmlFor={id} className={`cursor-pointer block p-3 border-2 rounded-xl text-center transition-all ${promptData.composition === value ? 'bg-blue-600 text-white border-blue-600 shadow-lg' : 'border-gray-300 hover:border-blue-300'}`}>
                                        {label}
                                    </label>
                                </div>
                            ))}
                        </div>
                        <div>
                            <label htmlFor="customComposition" className="block text-sm font-medium text-gray-700 mb-1">Add Custom Details for Composition (Optional):</label>
                            <textarea
                                id="customComposition"
                                name="customComposition"
                                rows="2"
                                value={promptData.customComposition}
                                onChange={handleDataChange}
                                placeholder="e.g., shot on 50mm lens, low angle, leading lines"
                                className="w-full p-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-200/50 transition resize-none"
                            ></textarea>
                        </div>
                    </div>
                );
            case 5:
                return (
                    <div className="space-y-4">
                        <p className="text-sm text-gray-500 mb-3">Add technical terms to ensure maximum quality.</p>
                        <input
                            type="text"
                            id="finalMods"
                            name="finalMods"
                            value={promptData.finalMods}
                            onChange={handleDataChange}
                            placeholder="e.g., 8k, highly detailed, smooth, trending on ArtStation"
                            className="w-full p-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-200/50 transition"
                        />
                        <p className="text-xs text-gray-500">Suggested default: `8k, highly detailed, smooth, trending on ArtStation`</p>
                    </div>
                );
            case 6:
                return (
                    <div>
                        <p className="text-gray-600 mb-4">You have a structured prompt. Now, let's use AI to add rich descriptive flair!</p>


                        <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl mb-4">
                            <h3 className="text-blue-800 font-semibold mb-2">Structured Prompt:</h3>
                            <p className="text-sm text-blue-700 font-mono break-words">{generateBasePrompt()}</p>
                        </div>


                        <Button
                            type="primary"
                            onClick={generateEnhancedPrompt}
                            disabled={isGenerating}
                            className="mb-6"
                            icon={isGenerating ? null : Brain}
                        >
                            {isGenerating ? (
                                <span className="flex items-center text-white">
                                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                                    AI is thinking...
                                </span>
                            ) : "Enhance with AI (Deep Detail)"}
                        </Button>


                        <h3 className="text-gray-700 font-semibold mt-6 mb-2">Final Prompt for AI Client:</h3>
                        <div className="bg-gray-100 p-4 rounded-xl border border-gray-200">
                            <textarea
                                rows="8"
                                readOnly
                                value={getFinalPrompt()}
                                className="w-full bg-transparent text-lg font-mono text-gray-800 focus:outline-none resize-none"
                                style={{ border: 'none' }}
                            ></textarea>
                        </div>


                        <div className="mt-4 flex flex-col space-y-3">
                            <Button type="success" onClick={copyPrompt} icon={Clipboard}>
                                Copy Final Prompt
                            </Button>
                            <Button type="secondary" onClick={restart} icon={RotateCcw}>
                                Start Over
                            </Button>
                        </div>
                    </div>
                );
            default:
                return null;
        }
    }, [currentStep, promptData, handleDataChange, generateBasePrompt, isGenerating, generateEnhancedPrompt, getFinalPrompt, copyPrompt, restart, aiEnhancementText]);


    // --- Component Rendering ---


    const currentStepConfig = STEPS_CONFIG.find(step => step.id === currentStep);
    const progress = ((currentStep - 1) / (TOTAL_STEPS - 1)) * 100;


    return (
        <div className="min-h-screen bg-gray-50 flex items-start justify-center p-4 sm:p-8">
            <div className="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 sm:p-8 border border-gray-100">
                <h1 className="text-3xl font-extrabold text-gray-800 mb-1">AI Prompt Genius 🧠</h1>
                <p className="text-gray-500 mb-6 text-sm">Build your prompt, then let our AI give it a creative boost!</p>


                {/* Progress Bar */}
                <div className="mb-6">
                    <div className="h-2 bg-gray-200 rounded-full">
                        <div
                            className="h-2 bg-blue-600 rounded-full transition-all duration-500"
                            style={{ width: `${progress}%` }}
                        ></div>
                    </div>
                    <p className="text-sm text-gray-500 mt-1 text-right">
                        {currentStepConfig.id === TOTAL_STEPS ? 'Review & Finalize' : `Step ${currentStep} of ${TOTAL_STEPS - 1}`}
                    </p>
                </div>


                {/* Step Content */}
                <h2 className="text-xl font-semibold text-gray-700 mb-4">{currentStepConfig.title}</h2>
                {renderStepContent()}


                {/* Navigation Buttons */}
                <div className="mt-8 pt-4 border-t border-gray-200 flex justify-between">
                    <Button
                        type="nav-gray"
                        onClick={() => navigateStep(-1)}
                        disabled={currentStep === 1}
                        icon={ArrowLeft}
                        className="w-1/3"
                    >
                        Back
                    </Button>
                    {currentStep < TOTAL_STEPS ? (
                        <Button
                            type="nav-blue"
                            onClick={() => navigateStep(1)}
                            icon={ArrowRight}
                            className="w-1/3"
                        >
                            Next
                        </Button>
                    ) : (
                        <Button
                            type="secondary"
                            onClick={restart}
                            icon={RotateCcw}
                            className="w-1/3"
                        >
                            Start Over
                        </Button>
                    )}
                </div>
            </div>
            
            <MessageBox 
                message={message.text}
                type={message.type}
                isVisible={message.visible}
                onClose={() => setMessage(prev => ({ ...prev, visible: false }))}
            />
        </div>
    );
};


export default App;